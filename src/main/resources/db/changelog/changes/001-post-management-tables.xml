<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- Changeset: Add account_type column to social_accounts table -->
    <changeSet id="001-1" author="postiqa">
        <addColumn tableName="social_accounts">
            <column name="account_type" type="VARCHAR(20)" defaultValue="BUSINESS">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <!-- Changeset: Create posts table -->
    <changeSet id="001-2" author="postiqa">
        <createTable tableName="posts">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="created_by" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="content" type="TEXT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="scheduled_for" type="TIMESTAMP"/>
            <column name="metadata" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add foreign key to users table -->
        <addForeignKeyConstraint
            baseTableName="posts"
            baseColumnNames="created_by"
            constraintName="fk_posts_created_by"
            referencedTableName="users"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Create indexes -->
        <createIndex tableName="posts" indexName="idx_posts_created_by">
            <column name="created_by"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_type">
            <column name="type"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_scheduled_for">
            <column name="scheduled_for"/>
        </createIndex>
        <createIndex tableName="posts" indexName="idx_posts_created_at">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <!-- Changeset: Create post_channels table (many-to-many for cross-posting) -->
    <changeSet id="001-3" author="postiqa">
        <createTable tableName="post_channels">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="post_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="channel_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="external_post_id" type="VARCHAR(255)"/>
            <column name="published_at" type="TIMESTAMP"/>
            <column name="error_message" type="TEXT"/>
            <column name="metadata" type="JSONB"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add foreign keys -->
        <addForeignKeyConstraint
            baseTableName="post_channels"
            baseColumnNames="post_id"
            constraintName="fk_post_channels_post"
            referencedTableName="posts"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <addForeignKeyConstraint
            baseTableName="post_channels"
            baseColumnNames="channel_id"
            constraintName="fk_post_channels_channel"
            referencedTableName="social_accounts"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Create indexes -->
        <createIndex tableName="post_channels" indexName="idx_post_channels_post_id">
            <column name="post_id"/>
        </createIndex>
        <createIndex tableName="post_channels" indexName="idx_post_channels_channel_id">
            <column name="channel_id"/>
        </createIndex>
        <createIndex tableName="post_channels" indexName="idx_post_channels_status">
            <column name="status"/>
        </createIndex>
        <createIndex tableName="post_channels" indexName="idx_post_channels_published_at">
            <column name="published_at"/>
        </createIndex>
        <createIndex tableName="post_channels" indexName="idx_post_channels_external_post_id">
            <column name="external_post_id"/>
        </createIndex>
    </changeSet>

    <!-- Changeset: Create media table -->
    <changeSet id="001-4" author="postiqa">
        <createTable tableName="media">
            <column name="id" type="UUID">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="post_id" type="UUID">
                <constraints nullable="false"/>
            </column>
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="storage_key" type="VARCHAR(500)">
                <constraints nullable="false"/>
            </column>
            <column name="public_url" type="VARCHAR(1000)">
                <constraints nullable="false"/>
            </column>
            <column name="file_name" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mime_type" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="file_size" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="width" type="INTEGER"/>
            <column name="height" type="INTEGER"/>
            <column name="duration_seconds" type="INTEGER"/>
            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <!-- Add foreign key to posts table -->
        <addForeignKeyConstraint
            baseTableName="media"
            baseColumnNames="post_id"
            constraintName="fk_media_post"
            referencedTableName="posts"
            referencedColumnNames="id"
            onDelete="CASCADE"/>

        <!-- Create indexes -->
        <createIndex tableName="media" indexName="idx_media_post_id">
            <column name="post_id"/>
        </createIndex>
        <createIndex tableName="media" indexName="idx_media_type">
            <column name="type"/>
        </createIndex>
        <createIndex tableName="media" indexName="idx_media_storage_key">
            <column name="storage_key"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
